ERLC = erlc
CP = cp

EBIN = $(EB_TOP)ebin
ERL_COMPILE_FLAGS += -W +debug_info -I$(EB_TOP)core/engine
ERL_FILES = $(MODULES:%=%.erl)
TARGET_FILES= $(MODULES:%=$(EBIN)/%.beam)
TARGET_CONFIG_FILES = $(CONFIG_FILE:%=$(EBIN)/%)
all: compile .erlmake

ERLC_FLAGS = $(ERLC_FLAGS) $(COMPILE_FLAG)

SUBDIR_CMD = @set -e ; \
            for d in $(SUBDIRS); do                    \
            if test -f $$d/SKIP ; then                                  \
                echo "=== Skipping subdir $$d, reason:" ;               \
                cat $$d/SKIP ;                                          \
                echo "===" ;                                            \
            else                                                        \
                if test ! -d $$d ; then                                 \
                    echo "=== Skipping subdir $$d, it is missing" ;     \
                else                                                    \
                    xflag="" ;                                          \
                    if test -f $$d/ignore_config_record.inf; then       \
                        xflag=$$tflag ;                                 \
                    fi ;                                                \
                    (cd $$d && $(MAKE) $$xflag $@) || exit $$? ;        \
                fi ;                                                    \
            fi ;                                                        \
        done ;                                                          \
      

compile:$(TARGET_CONFIG_FILES) $(TARGET_FILES)
	 $(SUBDIR_CMD)

.erlmake:
	erl -make

test: clean compile
	erl -nologo -noshell -pz ebin -s testAll test -s init stop

$(EBIN)/%.beam: ./%.erl
	$(ERLC) $(ERL_COMPILE_FLAGS) -o$(EBIN) $<

$(EBIN)/%.app: ./%.app
	$(CP) $< $@

clean:
	rm -rf $(TARGET_FILES) $(TARGET_CONFIG_FILES)
	 $(SUBDIR_CMD)
